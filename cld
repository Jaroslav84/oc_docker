#!/bin/bash

set -e

SCRIPT_DIR="$( cd "$( dirname "$( realpath "${BASH_SOURCE[0]}" )" )" && pwd )"

# Check if Docker is running
if ! docker info > /dev/null 2>&1; then
    echo "Docker is not running. Starting Docker Desktop App..."
    
    # Start Docker Desktop on macOS
    if [[ "$OSTYPE" == "darwin"* ]]; then
        open -a Docker
    else
        echo "Please start Docker manually on your system"
        exit 1
    fi

    echo "Waiting for Docker to start (this may take a minute)..."
    max_wait=60
    waited=0
    until docker info > /dev/null 2>&1; do
        if [ $waited -ge $max_wait ]; then
            echo -e "\nError: Docker did not start within $max_wait seconds"
            exit 1
        fi
        echo -n "."
        sleep 2
        waited=$((waited + 2))
    done
    echo -e "\nDocker is ready!"
fi

# Capture current directory before changing to script directory
CURRENT_DIR=$(pwd)

# Check if first argument is a directory
if [ -d "$1" ]; then
    CURRENT_DIR=$(realpath "$1")
    shift
fi

cd "$SCRIPT_DIR"

# Calculate the working directory inside Docker
# If current dir is under ~/Projects, map it to /root/Projects/<relative_path>
PROJECTS_DIR="$HOME/Projects"
if [[ "$CURRENT_DIR" == "$PROJECTS_DIR"* ]]; then
    # Get relative path from ~/Projects
    RELATIVE_PATH="${CURRENT_DIR#$PROJECTS_DIR}"
    RELATIVE_PATH="${RELATIVE_PATH#/}"  # Remove leading slash if present
    if [ -z "$RELATIVE_PATH" ]; then
        DOCKER_WORKDIR="/root/Projects"
    else
        DOCKER_WORKDIR="/root/Projects/$RELATIVE_PATH"
    fi
else
    # If outside ~/Projects, default to /root/Projects
    DOCKER_WORKDIR="/root/Projects"
    echo "Warning: Path $CURRENT_DIR is outside ~/Projects, starting in /root/Projects"
fi

echo "Starting Claude Code sandbox in $DOCKER_WORKDIR..."

# Forward terminal environment variables for proper mouse reporting and scrolling
# Get terminal size if available
if command -v stty > /dev/null 2>&1; then
    TERM_SIZE=$(stty size 2>/dev/null || echo "24 80")
    export LINES=$(echo $TERM_SIZE | cut -d' ' -f1)
    export COLUMNS=$(echo $TERM_SIZE | cut -d' ' -f2)
fi

# Ensure TERM is set (default to xterm-256color for iTerm compatibility)
export TERM=${TERM:-xterm-256color}

# Use docker run directly to have control over volume mounts for Claude
# Load environment variables from .env file if it exists
ENV_FILE=""
if [ -f "$SCRIPT_DIR/.env" ]; then
    ENV_FILE="--env-file $SCRIPT_DIR/.env"
fi

docker run --rm -it \
    -w "$DOCKER_WORKDIR" \
    -v ~/Projects:/root/Projects \
    -v /var/run/docker.sock:/var/run/docker.sock:ro \
    -v ~/.llm_docker/claude:/root \
    -v "$SCRIPT_DIR/opencode.config.jsonc:/tmp/opencode.config.jsonc:ro" \
    -v "$SCRIPT_DIR/docker-entrypoint.sh:/usr/local/bin/docker-entrypoint.sh:ro" \
    --network host \
    --cap-drop ALL \
    --cap-add NET_BIND_SERVICE \
    --security-opt no-new-privileges:true \
    -e SANDBOX_MODE=true \
    -e TERM \
    -e COLUMNS \
    -e LINES \
    -e TOOL=claude \
    $ENV_FILE \
    llm-docker:latest "$@"
