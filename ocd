#!/bin/bash

set -e

SCRIPT_DIR="$( cd "$( dirname "$( realpath "${BASH_SOURCE[0]}" )" )" && pwd )"

# Check if Docker is running
if ! docker info > /dev/null 2>&1; then
    echo "Docker is not running. Starting Docker Desktop App..."
    
    # Start Docker Desktop on macOS
    if [[ "$OSTYPE" == "darwin"* ]]; then
        open -a Docker
    else
        echo "Please start Docker manually on your system"
        exit 1
    fi

    echo "Waiting for Docker to start (this may take a minute)..."
    max_wait=60
    waited=0
    until docker info > /dev/null 2>&1; do
        if [ $waited -ge $max_wait ]; then
            echo -e "\nError: Docker did not start within $max_wait seconds"
            exit 1
        fi
        echo -n "."
        sleep 2
        waited=$((waited + 2))
    done
    echo -e "\nDocker is ready!"
fi

# Capture current directory before changing to script directory
CURRENT_DIR=$(pwd)

# Check if first argument is a directory
if [ -d "$1" ]; then
    CURRENT_DIR=$(realpath "$1")
    shift
fi

cd "$SCRIPT_DIR"

# Calculate the working directory inside Docker
# If current dir is under ~/Projects, map it to /root/Projects/<relative_path>
PROJECTS_DIR="$HOME/Projects"
if [[ "$CURRENT_DIR" == "$PROJECTS_DIR"* ]]; then
    # Get relative path from ~/Projects
    RELATIVE_PATH="${CURRENT_DIR#$PROJECTS_DIR}"
    RELATIVE_PATH="${RELATIVE_PATH#/}"  # Remove leading slash if present
    if [ -z "$RELATIVE_PATH" ]; then
        DOCKER_WORKDIR="/root/Projects"
    else
        DOCKER_WORKDIR="/root/Projects/$RELATIVE_PATH"
    fi
else
    # If outside ~/Projects, default to /root/Projects
    DOCKER_WORKDIR="/root/Projects"
    echo "Warning: Path $CURRENT_DIR is outside ~/Projects, starting in /root/Projects"
fi

echo "Starting OpenCode sandbox in $DOCKER_WORKDIR..."

# Forward terminal environment variables for proper mouse reporting and scrolling
# Get terminal size if available
if command -v stty > /dev/null 2>&1; then
    TERM_SIZE=$(stty size 2>/dev/null || echo "24 80")
    export LINES=$(echo $TERM_SIZE | cut -d' ' -f1)
    export COLUMNS=$(echo $TERM_SIZE | cut -d' ' -f2)
fi

# Ensure TERM is set (default to xterm-256color for iTerm compatibility)
export TERM=${TERM:-xterm-256color}

docker compose run --rm -w "$DOCKER_WORKDIR" \
    -e TERM \
    -e COLUMNS \
    -e LINES \
    -e TOOL=opencode \
    llm_docker "$@"
